#!/bin/bash

if [ -f /var/lock/subsys/rsync_updates ]; then
  echo "Updates via rsync already running."
  exit 0
fi

base_dir="/var/www/html/centos/"
centos_7_mirror_dir="/var/www/html/centos/7/"
centos_6_mirror_dir="/var/www/html/centos/6/"

touch /var/lock/subsys/rsync_updates

if [[ -d "$centos_7_mirror_dir" && -d "$centos_6_mirror_dir" ]] ; then
  # sync repos
  rsync -avSHP --delete rsync://repos.mia.quadranet.com/centos/7/ "$centos_7_mirror_dir" && \
  rsync -avSHP --delete rsync://repos.mia.quadranet.com/centos/6/ "$centos_6_mirror_dir" && \
  # sync keys
  rsync -avSHP --delete rsync://repos.mia.quadranet.com/centos/RPM-GPG-KEY-CentOS-7 "$base_dir" && \
  rsync -avSHP --delete rsync://repos.mia.quadranet.com/centos/RPM-GPG-KEY-CentOS-6 "$base_dir" && \
  rm -rf /var/lock/subsys/rsync_updates

else
	echo "Directories doesn't exist"

fi
